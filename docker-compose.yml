---
version: "3.8"
services:
  backend-flask:
    environment:
      FRONTEND_URL: https://3000-${GITPOD_WORKSPACE_ID}.${GITPOD_WORKSPACE_CLUSTER_HOST}
      BACKEND_URL: https://4567-${GITPOD_WORKSPACE_ID}.${GITPOD_WORKSPACE_CLUSTER_HOST}
      OTEL_SERVICE_NAME: 'cruddur-backend-flask'
      OTEL_EXPORTER_OTLP_ENDPOINT: "https://api.honeycomb.io"
      OTEL_EXPORTER_OTLP_HEADERS: "x-honeycomb-team=${HONEYCOMB_API_KEY}"
    build: ./backend-flask
    container_name: backend
    ports:
      - 4567:4567
    depends_on:
      - db
      - dynamodb
    healthcheck:
      test: ["CMD", "wget", "-q", "-O/dev/null", "http://localhost:4567/api/activities/home", "--header", "Accept: application/json", "--header", "Content-Type: application/json"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 15s
    volumes:
      - type: bind
        source: ./backend-flask
        target: /backend-flask
        read_only: true
  frontend-react-js:
    environment:
      REACT_APP_BACKEND_URL: https://4567-${GITPOD_WORKSPACE_ID}.${GITPOD_WORKSPACE_CLUSTER_HOST}
    build: ./frontend-react-js
    container_name: frontend
    ports:
      - 3000:3000
    depends_on:
      - backend-flask
    healthcheck:
      test: ["CMD", "wget", "-q", "-O/dev/null", "http://localhost:3000"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 15s
    volumes:
      - type: bind
        source: ./frontend-react-js/src
        target: /frontend-react-js/src
        read_only: true
  db:
    image: postgres:13-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    container_name: db
    ports:
      - 5432:5432
    volumes:
      - type: bind
        source: /workspace/docker/psqldb
        target: /var/lib/postgresql/data
  dynamodb:
    # https://stackoverflow.com/questions/67533058/persist-local-dynamodb-data-in-volumes-lack-permission-unable-to-open-databa
    # We needed to add user:root to get this working.
    user: root
    command: -jar DynamoDBLocal.jar -sharedDb -dbPath ./data
    image: amazon/dynamodb-local:latest
    restart: unless-stopped
    container_name: dynamodb
    ports:
      - 8000:8000
    volumes:
      - type: bind
        source: /workspace/docker/dynamodb
        target: /home/dynamodblocal/data
    working_dir: /home/dynamodblocal

# the name flag is a hack to change the default prepend folder
# name when outputting the image names
networks:
  internal-network:
    driver: bridge
    name: cruddur
